# utils related to integration tests
# Prepare things for an integration test
- builder:
    name: 'prepare-integration-test'
    builders:
    - set-common-environment
    - get-build-details
    - setup-go-environment
    - get-s3-source-payload
    - set-test-description

- builder:
    name: 'run-integration-test'
    builders:
    - prepare-integration-test
    - get-s3-build-payload-testing:
          SHORT_GIT_COMMIT: "${{SHORT_GIT_COMMIT}}"
          platform: "linux/${{BUILD_ARCH}}"
    - integration-test-runner:
          test_name: "{test_name}"
          task_name: "{task_name}"
          skip_tasks: "{skip_tasks}"

- builder:
    name: 'run-integration-test-ephemeral'
    builders:
    - wait-for-cloud-init
    - prepare-integration-test
    - get-s3-build-payload-testing:
          SHORT_GIT_COMMIT: "${{SHORT_GIT_COMMIT}}"
          platform: "linux/${{BUILD_ARCH}}"
    - integration-test-runner-ephemeral:
          pre_test_steps: "{pre_test_steps}"
          test_name: "{test_name}"
          task_name: "{task_name}"
          skip_tasks: "{skip_tasks}"
          setup_steps: ""

- builder:
    name: 'run-integration-test-ephemeral-microk8s'
    builders:
    - prepare-integration-test
    - get-s3-build-payload-testing:
          SHORT_GIT_COMMIT: "${{SHORT_GIT_COMMIT}}"
          platform: "linux/${{BUILD_ARCH}}"
    - shell: |-
        #!/bin/bash
        sudo getent group microk8s || sudo addgroup microk8s &&
        sudo getent group docker || sudo addgroup docker &&
        sudo usermod -a -G microk8s,docker $USER
    - integration-test-runner-ephemeral:
          pre_test_steps:
            !include-raw: "../scripts/microk8s-setup.sh"
          test_name: "{test_name}"
          task_name: "{task_name}"
          skip_tasks: "{skip_tasks}"
          setup_steps: ""
